*** Settings ***
Documentation     {{ bot.bot.name }}
...               {{ bot.bot.description or '' }}
Library           Collections
Library           String
Library           OperatingSystem
{% set node_types_str = bot.nodes | map(attribute='type') | join(',') %}
{% if 'web.' in node_types_str or 'browser.' in node_types_str %}
Library           RPA.Browser.Selenium
{% endif %}
{% if 'excel.' in node_types_str %}
Library           skuldbot.libs.ExcelLibrary
{% endif %}
{% if 'files.' in node_types_str %}
Library           RPA.FileSystem
{% endif %}
{% if 'data.' in node_types_str %}
Library           skuldbot.libs.DataLibrary
{% endif %}
{% if 'secrets.' in node_types_str %}
Library           skuldbot.libs.vault    WITH NAME    SkuldVault
Library           skuldbot.libs.local_vault    WITH NAME    LocalVault
{% endif %}
Library           skuldbot.libs.ControlLibrary
Resource          resources/error_handler.robot
{% if bot.variables %}
Variables         variables/config.yaml
{% endif %}

*** Variables ***
${BOT_ID}         {{ bot.bot.id }}
${BOT_NAME}       {{ bot.bot.name }}
${BOT_STATUS}     RUNNING
# Global error variables (last error)
${LAST_ERROR}     ${EMPTY}
${LAST_ERROR_NODE}    ${EMPTY}
${LAST_ERROR_TYPE}    ${EMPTY}
# Per-node state dictionaries (status, output, error, data)
# Using scalar syntax ${} to allow access like ${NODE_xxx}[key]
{% for node in bot.nodes %}
${NODE_{{ node.id | replace('-', '_') }}}    &{EMPTY}
{% endfor %}

*** Tasks ***
Execute Bot
    [Documentation]    Entry point del bot
    [Tags]             main
    
    Log    Starting bot: ${BOT_NAME}    console=yes
    Set Global Variable    ${BOT_STATUS}    RUNNING
    
    TRY
        Run Bot Flow
        Set Global Variable    ${BOT_STATUS}    SUCCESS
        Log    Bot completed successfully    console=yes
    EXCEPT    AS    ${error_msg}
        Set Global Variable    ${BOT_STATUS}    FAILED
        Log    Bot failed: ${error_msg}    level=ERROR    console=yes
    END

*** Keywords ***
Run Bot Flow
    [Documentation]    Ejecuta el flujo completo del bot

    # Initialize per-node state dictionaries
{% for node in bot.nodes %}
    &{init_{{ node.id | replace('-', '_') }}}=    Create Dictionary    status=pending    output=${EMPTY}    error=${EMPTY}
    Set Global Variable    ${NODE_{{ node.id | replace('-', '_') }}}    ${init_{{ node.id | replace('-', '_') }}}
{% endfor %}

{% set start_node = bot.get_start_node() %}
{% if start_node %}
    ${current_node}=    Set Variable    {{ start_node.id }}
{% else %}
    ${current_node}=    Set Variable    {{ bot.nodes[0].id }}
{% endif %}
    
    # Loop principal - ejecuta nodos hasta llegar a END
    WHILE    '${current_node}' != 'END'    limit=1000
        Log    → Executing node: ${current_node}    console=yes
        
        ${current_node}=    Execute Node By ID    ${current_node}
    END
    
    Log    Flow completed    console=yes

Execute Node By ID
    [Arguments]    ${node_id}
    [Documentation]    Ejecuta un nodo por su ID y retorna el siguiente nodo
    
{% for node in bot.nodes %}
    IF    '${node_id}' == '{{ node.id }}'
        TRY
            # Node: {{ node.id }} ({{ node.type }})
{# ===== TRIGGERS ===== #}
{% if node.type == 'trigger.manual' or node.type == 'trigger.form' or node.type == 'trigger.schedule' or node.type == 'trigger.webhook' %}
            # Trigger node - initializes the bot
            Log    Bot triggered: {{ node.type }}    console=yes

{# ===== LOGGING ===== #}
{% elif node.type == 'control.log' or node.type == 'logging.log' %}
            Log    {{ node.config.get('message', 'Log message') | transform_vars }}    level={{ node.config.get('level', 'INFO') }}    console=yes
{% elif node.type == 'logging.screenshot' %}
            Capture Page Screenshot    filename={{ node.config.get('description', 'screenshot') }}.png
            Log    Screenshot captured: {{ node.config.get('description', 'screenshot') }}    console=yes

{# ===== CONTROL FLOW ===== #}
{% elif node.type == 'control.wait' %}
            Sleep    {{ node.config.get('seconds', 1) }}s
{% elif node.type == 'control.set_variable' %}
            Set Global Variable    ${{ '{' }}{{ node.config.get('name', 'VAR') }}{{ '}' }}    {{ node.config.get('value', '') | transform_vars }}
{% elif node.type == 'control.stop' %}
            Log    Bot stopping with status: {{ node.config.get('status', 'success') }}    console=yes
            RETURN    END

{# ===== WEB AUTOMATION ===== #}
{% elif node.type == 'web.open_browser' or node.type == 'browser.open' %}
            Open Available Browser    {{ node.config.get('url', 'about:blank') | transform_vars }}    browser={{ node.config.get('browser', 'chromium') }}    headless=${{ '{TRUE}' if node.config.get('headless', False) else '{FALSE}' }}
{% elif node.type == 'web.navigate' %}
            Go To    {{ node.config.get('url', '') | transform_vars }}
{% elif node.type == 'web.click' or node.type == 'browser.click' %}
            Click Element    {{ node.config.get('selector', '') | transform_vars }}
{% elif node.type == 'web.type' or node.type == 'browser.fill' %}
            {% if node.config.get('clear', True) %}
            Clear Element Text    {{ node.config.get('selector', '') | transform_vars }}
            {% endif %}
            Input Text    {{ node.config.get('selector', '') | transform_vars }}    {{ node.config.get('text', node.config.get('value', '')) | transform_vars }}
{% elif node.type == 'web.select_option' %}
            Select From List By Value    {{ node.config.get('selector', '') | transform_vars }}    {{ node.config.get('value', '') | transform_vars }}
{% elif node.type == 'web.get_text' %}
            ${text}=    Get Text    {{ node.config.get('selector', '') | transform_vars }}
            Set Global Variable    ${LAST_TEXT}    ${text}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${text}    text=${text}
            Log    Got text: ${text}    console=yes
{% elif node.type == 'web.get_attribute' %}
            ${value}=    Get Element Attribute    {{ node.config.get('selector', '') | transform_vars }}    {{ node.config.get('attribute', '') }}
            Set Global Variable    ${LAST_ATTRIBUTE}    ${value}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${value}    attribute=${value}
            Log    Got attribute: ${value}    console=yes
{% elif node.type == 'web.screenshot' %}
            {% if node.config.get('full_page', False) %}
            Capture Page Screenshot    {{ node.config.get('path', 'screenshot.png') | transform_vars }}
            {% else %}
            Capture Page Screenshot    {{ node.config.get('path', 'screenshot.png') | transform_vars }}
            {% endif %}
{% elif node.type == 'web.wait_element' %}
            Wait Until Element Is Visible    {{ node.config.get('selector', '') | transform_vars }}    timeout={{ node.config.get('timeout', 30000) // 1000 }}s
{% elif node.type == 'web.execute_js' %}
            ${result}=    Execute Javascript    {{ node.config.get('script', '') | transform_vars }}
            Set Global Variable    ${JS_RESULT}    ${result}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    jsResult=${result}
{% elif node.type == 'web.scroll' %}
            {% if node.config.get('direction') == 'to_element' %}
            Scroll Element Into View    {{ node.config.get('selector', '') | transform_vars }}
            {% else %}
            Execute Javascript    window.scrollBy(0, {{ '500' if node.config.get('direction') == 'down' else '-500' }})
            {% endif %}
{% elif node.type == 'web.close_browser' or node.type == 'browser.close' %}
            Close Browser

{# ===== EXCEL (SkuldBot ExcelLibrary) ===== #}
{% elif node.type == 'excel.open' %}
            Open Excel    {{ node.config.get('path', '') | transform_vars }}
{% elif node.type == 'excel.read_range' or node.type == 'excel.read' %}
            {% if node.config.get('column_names') and not node.config.get('header', True) %}
            ${result}=    Read Excel Range    sheet_name={{ node.config.get('sheet', 'None') | transform_vars }}    header=${FALSE}    column_names={{ node.config.get('column_names', '') }}
            {% else %}
            ${result}=    Read Excel Range    sheet_name={{ node.config.get('sheet', 'None') | transform_vars }}    header=${{ '{TRUE}' if node.config.get('header', True) else '{FALSE}' }}
            {% endif %}
            ${EXCEL_DATA}=    Set Variable    ${result}[data]
            ${EXCEL_ROW_COUNT}=    Set Variable    ${result}[rowCount]
            Set Global Variable    ${EXCEL_DATA}
            Set Global Variable    ${EXCEL_ROW_COUNT}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    data=${EXCEL_DATA}    rowCount=${EXCEL_ROW_COUNT}
            Log    Read ${EXCEL_ROW_COUNT} rows from Excel    console=yes
{% elif node.type == 'excel.write_range' or node.type == 'excel.write' %}
            Write Data To Excel    ${EXCEL_DATA}    {{ node.config.get('sheet', 'Sheet1') | transform_vars }}
{% elif node.type == 'excel.read_cell' %}
            ${value}=    Get Cell Value    {{ node.config.get('cell', 'A1') | transform_vars }}
            Set Global Variable    ${CELL_VALUE}    ${value}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${value}    cellValue=${value}
            Log    Cell value: ${value}    console=yes
{% elif node.type == 'excel.write_cell' %}
            Set Cell Value    {{ node.config.get('cell', 'A1') | transform_vars }}    {{ node.config.get('value', '') | transform_vars }}
{% elif node.type == 'excel.save' %}
            Save And Close Excel
{% elif node.type == 'excel.close' %}
            Close Excel Without Saving

{# ===== FILES ===== #}
{% elif node.type == 'files.read' %}
            ${content}=    Get File    {{ node.config.get('path', '') | transform_vars }}    encoding={{ node.config.get('encoding', 'utf-8') }}
            Set Global Variable    ${FILE_CONTENT}    ${content}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${content}    content=${content}
            Log    File read: {{ node.config.get('path', '') | transform_vars }}    console=yes
{% elif node.type == 'files.write' %}
            {% if node.config.get('append', False) %}
            Append To File    {{ node.config.get('path', '') | transform_vars }}    {{ node.config.get('content', '') | transform_vars }}    encoding=utf-8
            {% else %}
            Create File    {{ node.config.get('path', '') | transform_vars }}    {{ node.config.get('content', '') | transform_vars }}    encoding=utf-8
            {% endif %}
            Log    File written: {{ node.config.get('path', '') | transform_vars }}    console=yes
{% elif node.type == 'files.copy' %}
            Copy File    {{ node.config.get('source', '') | transform_vars }}    {{ node.config.get('destination', '') | transform_vars }}
            Log    File copied    console=yes
{% elif node.type == 'files.move' %}
            Move File    {{ node.config.get('source', '') | transform_vars }}    {{ node.config.get('destination', '') | transform_vars }}
            Log    File moved    console=yes
{% elif node.type == 'files.delete' %}
            Remove File    {{ node.config.get('path', '') | transform_vars }}
            Log    File deleted    console=yes
{% elif node.type == 'files.create_folder' %}
            Create Directory    {{ node.config.get('path', '') | transform_vars }}
            Log    Folder created    console=yes
{% elif node.type == 'files.exists' %}
            ${exists}=    Does File Exist    {{ node.config.get('path', '') | transform_vars }}
            Set Global Variable    ${FILE_EXISTS}    ${exists}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${exists}    exists=${exists}
            Log    File exists check: ${exists}    console=yes

{# ===== API ===== #}
{% elif node.type == 'api.http_request' %}
            ${response}=    Evaluate    __import__('requests').{{ node.config.get('method', 'get').lower() }}('{{ node.config.get('url', '') | transform_vars }}'{% if node.config.get('headers') %}, headers={{ node.config.get('headers') | transform_vars }}{% endif %}{% if node.config.get('body') %}, json={{ node.config.get('body') | transform_vars }}{% endif %})
            Set Global Variable    ${HTTP_RESPONSE}    ${response.text}
            Set Global Variable    ${HTTP_STATUS}    ${response.status_code}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${response.text}    response=${response.text}    status_code=${response.status_code}
            Log    HTTP ${HTTP_STATUS}    console=yes
{% elif node.type == 'api.rest_get' %}
            ${response}=    Evaluate    __import__('requests').get('{{ node.config.get('url', '') | transform_vars }}'{% if node.config.get('headers') %}, headers={{ node.config.get('headers') | transform_vars }}{% endif %})
            Set Global Variable    ${HTTP_RESPONSE}    ${response.text}
            Set Global Variable    ${HTTP_STATUS}    ${response.status_code}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${response.text}    response=${response.text}    status_code=${response.status_code}
            Log    GET ${HTTP_STATUS}    console=yes
{% elif node.type == 'api.rest_post' %}
            ${response}=    Evaluate    __import__('requests').post('{{ node.config.get('url', '') | transform_vars }}', json={{ node.config.get('body', '{}') | transform_vars }}{% if node.config.get('headers') %}, headers={{ node.config.get('headers') | transform_vars }}{% endif %})
            Set Global Variable    ${HTTP_RESPONSE}    ${response.text}
            Set Global Variable    ${HTTP_STATUS}    ${response.status_code}
            # Store in node-specific variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${response.text}    response=${response.text}    status_code=${response.status_code}
            Log    POST ${HTTP_STATUS}    console=yes

{# ===== DATA INTEGRATION (TAPS) ===== #}
{% elif node.type.startswith('data.tap.') %}
            {% set tap_type = node.type.replace('data.tap.', '') %}
            {% if tap_type in ['sqlserver', 'oracle', 'postgres', 'mysql', 'db2', 'snowflake'] %}
            # Database extraction: {{ tap_type }}
            ${result}=    Extract From Database    db_type={{ tap_type }}
            ...    host={{ node.config.get('host', '') | transform_vars }}
            ...    database={{ node.config.get('database', '') | transform_vars }}
            ...    username={{ node.config.get('username', '') | transform_vars }}
            ...    password={{ node.config.get('password', '') | transform_vars }}
            {% if node.config.get('port') %}...    port={{ node.config.get('port') }}{% endif %}
            {% if node.config.get('query') %}...    query={{ node.config.get('query', '') | transform_vars }}{% endif %}
            {% if node.config.get('table') %}...    table={{ node.config.get('table', '') | transform_vars }}{% endif %}
            {% if node.config.get('columns') %}...    columns={{ node.config.get('columns', '') | transform_vars }}{% endif %}
            {% if node.config.get('filter') %}...    filter={{ node.config.get('filter', '') | transform_vars }}{% endif %}
            {% if node.config.get('limit') %}...    limit={{ node.config.get('limit') }}{% endif %}
            ...    mode={{ node.config.get('mode', 'memory') }}
            ...    batch_size={{ node.config.get('batch_size', 10000) }}
            {% elif tap_type == 'csv' %}
            # CSV extraction
            ${result}=    Extract From CSV    path={{ node.config.get('path', '') | transform_vars }}
            ...    delimiter={{ node.config.get('delimiter', ',') }}
            ...    encoding={{ node.config.get('encoding', 'utf-8') }}
            ...    header=${{ '{TRUE}' if node.config.get('header', True) else '{FALSE}' }}
            {% if node.config.get('columns') %}...    columns={{ node.config.get('columns', '') | transform_vars }}{% endif %}
            {% if node.config.get('limit') %}...    limit={{ node.config.get('limit') }}{% endif %}
            {% elif tap_type == 'excel' %}
            # Excel extraction
            ${result}=    Extract From Excel    path={{ node.config.get('path', '') | transform_vars }}
            {% if node.config.get('sheet') %}...    sheet={{ node.config.get('sheet', '') | transform_vars }}{% endif %}
            ...    header=${{ '{TRUE}' if node.config.get('header', True) else '{FALSE}' }}
            {% if node.config.get('columns') %}...    columns={{ node.config.get('columns', '') | transform_vars }}{% endif %}
            {% if node.config.get('limit') %}...    limit={{ node.config.get('limit') }}{% endif %}
            {% elif tap_type == 's3' %}
            # S3 extraction
            ${result}=    Extract From S3    bucket={{ node.config.get('bucket', '') | transform_vars }}
            ...    key={{ node.config.get('key', '') | transform_vars }}
            ...    aws_access_key={{ node.config.get('aws_access_key', '') | transform_vars }}
            ...    aws_secret_key={{ node.config.get('aws_secret_key', '') | transform_vars }}
            ...    region={{ node.config.get('region', 'us-east-1') }}
            ...    file_type={{ node.config.get('file_type', 'csv') }}
            {% elif tap_type == 'sftp' %}
            # SFTP extraction
            ${result}=    Extract From SFTP    host={{ node.config.get('host', '') | transform_vars }}
            ...    path={{ node.config.get('path', '') | transform_vars }}
            ...    username={{ node.config.get('username', '') | transform_vars }}
            {% if node.config.get('password') %}...    password={{ node.config.get('password', '') | transform_vars }}{% endif %}
            {% if node.config.get('private_key') %}...    private_key={{ node.config.get('private_key', '') | transform_vars }}{% endif %}
            ...    port={{ node.config.get('port', 22) }}
            ...    file_type={{ node.config.get('file_type', 'csv') }}
            {% elif tap_type == 'salesforce' %}
            # Salesforce extraction
            ${result}=    Extract From Salesforce
            ...    username={{ node.config.get('username', '') | transform_vars }}
            ...    password={{ node.config.get('password', '') | transform_vars }}
            ...    security_token={{ node.config.get('security_token', '') | transform_vars }}
            ...    query={{ node.config.get('query', '') | transform_vars }}
            ...    domain={{ node.config.get('domain', 'login') }}
            {% elif tap_type == 'rest_api' %}
            # REST API extraction
            ${result}=    Extract From REST API    url={{ node.config.get('url', '') | transform_vars }}
            ...    method={{ node.config.get('method', 'GET') }}
            {% if node.config.get('headers') %}...    headers={{ node.config.get('headers', '') | transform_vars }}{% endif %}
            {% if node.config.get('body') %}...    body={{ node.config.get('body', '') | transform_vars }}{% endif %}
            {% if node.config.get('auth_type') %}...    auth_type={{ node.config.get('auth_type', '') }}{% endif %}
            {% if node.config.get('auth_value') %}...    auth_value={{ node.config.get('auth_value', '') | transform_vars }}{% endif %}
            {% if node.config.get('pagination_type') %}...    pagination_type={{ node.config.get('pagination_type', '') }}{% endif %}
            {% if node.config.get('pagination_param') %}...    pagination_param={{ node.config.get('pagination_param', '') }}{% endif %}
            {% if node.config.get('data_path') %}...    data_path={{ node.config.get('data_path', '') }}{% endif %}
            {% if node.config.get('limit') %}...    limit={{ node.config.get('limit') }}{% endif %}
            {% else %}
            Log    Unknown tap type: {{ tap_type }}    level=WARN    console=yes
            ${result}=    Create Dictionary    records=@{EMPTY}    columns=@{EMPTY}    recordCount=0
            {% endif %}
            # Store tap results in node variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    records=${result}[records]    columns=${result}[columns]    recordCount=${result}[recordCount]
            Log    Extracted ${result}[recordCount] records    console=yes

{# ===== DATA INTEGRATION (TARGETS) ===== #}
{% elif node.type.startswith('data.target.') %}
            {% set target_type = node.type.replace('data.target.', '') %}
            {% if target_type in ['sqlserver', 'oracle', 'postgres', 'mysql', 'db2', 'snowflake'] %}
            # Database load: {{ target_type }}
            ${result}=    Load To Database    db_type={{ target_type }}
            ...    host={{ node.config.get('host', '') | transform_vars }}
            ...    database={{ node.config.get('database', '') | transform_vars }}
            ...    username={{ node.config.get('username', '') | transform_vars }}
            ...    password={{ node.config.get('password', '') | transform_vars }}
            ...    table={{ node.config.get('table', '') | transform_vars }}
            ...    records={{ node.config.get('records', '[]') | transform_vars }}
            {% if node.config.get('port') %}...    port={{ node.config.get('port') }}{% endif %}
            ...    mode={{ node.config.get('mode', 'insert') }}
            ...    batch_size={{ node.config.get('batch_size', 5000) }}
            {% elif target_type == 'bigquery' %}
            # BigQuery load
            ${result}=    Load To BigQuery
            ...    project={{ node.config.get('project', '') | transform_vars }}
            ...    dataset={{ node.config.get('dataset', '') | transform_vars }}
            ...    table={{ node.config.get('table', '') | transform_vars }}
            ...    records={{ node.config.get('records', '[]') | transform_vars }}
            ...    credentials_json={{ node.config.get('credentials_json', '') | transform_vars }}
            ...    mode={{ node.config.get('mode', 'append') }}
            {% elif target_type == 'csv' %}
            # CSV write
            ${result}=    Load To CSV    path={{ node.config.get('path', '') | transform_vars }}
            ...    records={{ node.config.get('records', '[]') | transform_vars }}
            ...    delimiter={{ node.config.get('delimiter', ',') }}
            ...    encoding={{ node.config.get('encoding', 'utf-8') }}
            ...    append=${{ '{TRUE}' if node.config.get('append', False) else '{FALSE}' }}
            {% elif target_type == 'excel' %}
            # Excel write
            ${result}=    Load To Excel    path={{ node.config.get('path', '') | transform_vars }}
            ...    records={{ node.config.get('records', '[]') | transform_vars }}
            ...    sheet={{ node.config.get('sheet', 'Sheet1') | transform_vars }}
            {% elif target_type == 's3' %}
            # S3 upload
            ${result}=    Load To S3    bucket={{ node.config.get('bucket', '') | transform_vars }}
            ...    key={{ node.config.get('key', '') | transform_vars }}
            ...    records={{ node.config.get('records', '[]') | transform_vars }}
            ...    aws_access_key={{ node.config.get('aws_access_key', '') | transform_vars }}
            ...    aws_secret_key={{ node.config.get('aws_secret_key', '') | transform_vars }}
            ...    region={{ node.config.get('region', 'us-east-1') }}
            ...    file_type={{ node.config.get('file_type', 'csv') }}
            {% elif target_type == 'sftp' %}
            # SFTP upload
            ${result}=    Load To SFTP    host={{ node.config.get('host', '') | transform_vars }}
            ...    path={{ node.config.get('path', '') | transform_vars }}
            ...    records={{ node.config.get('records', '[]') | transform_vars }}
            ...    username={{ node.config.get('username', '') | transform_vars }}
            {% if node.config.get('password') %}...    password={{ node.config.get('password', '') | transform_vars }}{% endif %}
            {% if node.config.get('private_key') %}...    private_key={{ node.config.get('private_key', '') | transform_vars }}{% endif %}
            ...    port={{ node.config.get('port', 22) }}
            ...    file_type={{ node.config.get('file_type', 'csv') }}
            {% else %}
            Log    Unknown target type: {{ target_type }}    level=WARN    console=yes
            ${result}=    Create Dictionary    insertedCount=0    updatedCount=0    errorCount=0    errors=@{EMPTY}
            {% endif %}
            # Store target results in node variable
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    insertedCount=${result}[insertedCount]    errorCount=${result}[errorCount]
            Log    Loaded ${result}[insertedCount] records (${result}[errorCount] errors)    console=yes

{# ===== SECRETS MANAGEMENT ===== #}
{% elif node.type == 'secrets.azure_keyvault' %}
            # Azure Key Vault - Load secrets into ${vault.xxx}
            Log    Connecting to Azure Key Vault: {{ node.config.get('vault_url', '') }}    console=yes
            ${secrets_list}=    Evaluate    [s.strip() for s in """{{ node.config.get('secrets', '') }}""".split('\\n') if s.strip()]
            ${result}=    SkuldVault.Init Azure Vault
            ...    vault_url={{ node.config.get('vault_url', '') | transform_vars }}
            ...    tenant_id={{ node.config.get('tenant_id', '') }}
            ...    client_id={{ node.config.get('client_id', '') }}
            ...    use_managed_identity=${{ '{TRUE}' if node.config.get('use_managed_identity', False) else '{FALSE}' }}
            ...    secrets=${secrets_list}
            # Store results
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    loaded=${result}[loaded]    secretNames=${result}[secretNames]
            Log    Loaded ${result}[loaded] secrets from Azure Key Vault    console=yes

{% elif node.type == 'secrets.aws_secrets' %}
            # AWS Secrets Manager - Load secrets into ${vault.xxx}
            Log    Connecting to AWS Secrets Manager ({{ node.config.get('region', 'us-east-1') }})    console=yes
            ${secrets_list}=    Evaluate    [s.strip() for s in """{{ node.config.get('secrets', '') }}""".split('\\n') if s.strip()]
            ${result}=    SkuldVault.Init AWS Vault
            ...    region={{ node.config.get('region', 'us-east-1') }}
            ...    use_iam_role=${{ '{TRUE}' if node.config.get('use_iam_role', True) else '{FALSE}' }}
            ...    secrets=${secrets_list}
            # Store results
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    loaded=${result}[loaded]    secretNames=${result}[secretNames]
            Log    Loaded ${result}[loaded] secrets from AWS Secrets Manager    console=yes

{% elif node.type == 'secrets.hashicorp_vault' %}
            # HashiCorp Vault - Load secrets into ${vault.xxx}
            Log    Connecting to HashiCorp Vault: {{ node.config.get('vault_addr', '') }}    console=yes
            ${secrets_list}=    Evaluate    [s.strip() for s in """{{ node.config.get('secrets', '') }}""".split('\\n') if s.strip()]
            ${result}=    SkuldVault.Init HashiCorp Vault
            ...    vault_addr={{ node.config.get('vault_addr', '') | transform_vars }}
            ...    auth_method={{ node.config.get('auth_method', 'token') }}
            ...    mount_point={{ node.config.get('mount_point', 'secret') }}
            ...    secrets_path={{ node.config.get('secrets_path', '') | transform_vars }}
            ...    secrets=${secrets_list}
            # Store results
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    loaded=${result}[loaded]    secretNames=${result}[secretNames]
            Log    Loaded ${result}[loaded] secrets from HashiCorp Vault    console=yes

{% elif node.type == 'secrets.local_vault' %}
            # Local Vault - Unlock and load secrets into ${vault.xxx}
            Log    Unlocking Local Vault: {{ node.config.get('vault_path', '.skuldbot') }}    console=yes
            ${secrets_list}=    Evaluate    [s.strip() for s in """{{ node.config.get('secrets', '') }}""".split('\\n') if s.strip()]
            ${result}=    LocalVault.Unlock And Load
            ...    vault_path={{ node.config.get('vault_path', '.skuldbot') | transform_vars }}
            ...    secrets=${secrets_list}
            # Store results
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    output=${result}    unlocked=${result}[unlocked]    secretCount=${result}[secretCount]    secretNames=${result}[secretNames]
            Log    Local Vault unlocked, loaded ${result}[secretCount] secrets    console=yes

{# ===== DEFAULT ===== #}
{% else %}
            Log    Node type {{ node.type }} not implemented yet    level=WARN    console=yes
{% endif %}
            
            # Success - Store node status (output already stored by specific node handlers)
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    status=success
            Set Global Variable    ${NODE_{{ node.id | replace('-', '_') }}}    ${NODE_{{ node.id | replace('-', '_') }}}
            Log    ✓ Node {{ node.id }} completed    console=yes
            RETURN    {{ node.outputs.success }}

        EXCEPT    AS    ${error_msg}
            # Error - Store in node-specific and global variables
            Set To Dictionary    ${NODE_{{ node.id | replace('-', '_') }}}    status=error    error=${error_msg}
            Set Global Variable    ${NODE_{{ node.id | replace('-', '_') }}}    ${NODE_{{ node.id | replace('-', '_') }}}
            Set Global Variable    ${LAST_ERROR}    ${error_msg}
            Set Global Variable    ${LAST_ERROR_NODE}    {{ node.id }}
            Set Global Variable    ${LAST_ERROR_TYPE}    {{ node.type }}
            Log    ✗ Node {{ node.id }} failed: ${error_msg}    level=ERROR    console=yes
            RETURN    {{ node.outputs.error }}
        END
    END
{% endfor %}
    
    # Node no encontrado
    Log    Unknown node: ${node_id}    level=ERROR
    RETURN    END

